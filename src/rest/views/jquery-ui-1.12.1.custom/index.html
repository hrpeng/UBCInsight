<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>User Interface</title>

    <!--<link rel="stylesheet" href="jquery-ui.min.css">-->
    <!--<script src="external/jquery/jquery.js"></script>-->
    <!--<script src="./src/rest/public/js/jquery-ui.js"></script>-->
    <link href="jquery-ui.css" rel="stylesheet">
    <!--<script src="script.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

    <script>
        $(document).ready(function() {
            $("#course").click(function () {
                var serializedSplit = $('#form1').serialize().split("&")
                console.log(serializedSplit)
                var aQuery = formQuery(serializedSplit)

                //console.log(aQuery)
                $.ajax({
                    url: 'http://localhost:4321/query',
                    type: 'post',
                    data: JSON.stringify(aQuery),
                    dataType: 'json',
                    contentType: 'application/json'
                }).done(function(data){
                    console.log("Response", data.result);
                    generateTable(data.result,"course")
                }).fail(function(error){
                    console.error("ERROR - Failed to submit")
                })
            });
        })

        $(document).ready(function() {
            $("#room").click(function () {
                var serializedSplit = $('#form2').serialize().split("&")
                var aQuery = formRoomQuery(serializedSplit)
                //console.log(serializedSplit)
                console.log(aQuery)
                $.ajax({
                    url: 'http://localhost:4321/query',
                    type: 'post',
                    data: JSON.stringify(aQuery),
                    dataType: 'json',
                    contentType: 'application/json'
                }).done(function(data){
                    //console.log("Response", data.result);
                    locationFilter(data.result,serializedSplit)
                }).fail(function(error){
                    console.error("ERROR - Failed to submit")
                })
            });
        })

        function formQuery(serializedSplit){
            var where = {}
            var aQuery = {}
            var direction
            var sortByKey = []

            // WHERE
            aQuery["WHERE"] = formWhere(serializedSplit)
            //
            for(i=0 ; i < serializedSplit.length; i++){
                if(serializedSplit[i].split("=")[1] == "UP"){
                    direction = 'UP'
                }else if(serializedSplit[i].split("=")[1] == "DOWN"){
                    direction = 'DOWN'
                }else if(serializedSplit[i].split("=")[0] == "SortBy"){
                    sortByKey.push(serializedSplit[i].split("=")[1])
                }
            }

            // OPTIONS
            var order
            var options = {}
            var allColumns = [
                "courses_dept",
                "courses_id",
                "courses_sec",
                "courses_avg",
                "courses_instructor",
                "courses_title",
                "courses_pass",
                "courses_fail",
                "courses_audit",
                "courses_year",
                "courses_uuid"
            ]

            console.log(sortByKey)
            if(sortByKey.length == 0){
                options["COLUMNS"] = allColumns
            }else {
                if (direction == undefined) {
                    if (sortByKey.length == 1) {
                        order = sortByKey[0]
                    }
                } else {
                    console.log("HIT")
                    order = {
                        "dir": direction,
                        "keys": sortByKey
                    }
                }
                options["COLUMNS"] = ["courses_dept", "courses_id"].concat(order["keys"])
                options["ORDER"] = order
                // TRANSFORMATIONS
                aQuery["TRANSFORMATIONS"] = formTransformations(sortByKey)
            }
            options["FORM"] = "TABLE"
            aQuery["OPTIONS"] = options
            console.log(aQuery)
            return aQuery
        }

        function formWhere(serializedSplit){
            var where = {}
            var and = []
            var whereKey
            var whereValue
            var logic
            for(i=0; i<serializedSplit.length; i++){
                whereKey = serializedSplit[i].split("=")[0]
                whereValue = serializedSplit[i].split("=")[1]
                var obj = {}
                if(whereValue != "" && whereValue != undefined){
                    switch (whereKey){
                        case "SectionSize":
                            obj[serializedSplit[i-1].split("=")[1]] = {
                                'courses_size': Number(whereValue)
                            }
                            and.push(obj)
                            break;
                        case "Department":
                            obj = {
                                "IS": {
                                    'courses_dept': whereValue
                                }
                            }
                            and.push(obj)
                            break;
                        case "CourseNumber":
                            obj = {
                                "IS": {
                                    'courses_id': whereValue
                                }
                            }
                            and.push(obj)
                            break;
                        case "Instructor":
                            obj = {
                                "IS": {
                                    'courses_instructor': whereValue
                                }
                            }
                            and.push(obj)
                            break;
                        case "Tilte":
                            obj = {
                                "IS": {
                                    'courses_title': whereValue
                                }
                            }
                            and.push(obj)
                            break;
                        case "Logic":
                            logic = whereValue
                            break;
                    }
                }
            }
            where[logic] = and
            //console.log(and)
            return where
        }

        function formTransformations(sortByKey){
            var apply = []
            var transformations = {}
            var item
            transformations["GROUP"] = ["courses_dept", "courses_id"]

            for(i=0;i<sortByKey.length;i++){
                switch (sortByKey[i]){
                    case "maxAvg":
                        item = {
                            "maxAvg": {
                                "MAX": "courses_avg"
                            }
                        }
                        break;
                    case "minAvg":
                        item = {
                            "minAvg": {
                                "MIN": "courses_avg"
                            }
                        }
                        break;
                    case "maxPass":
                        item = {
                            "maxPass": {
                                "MAX": "courses_pass"
                            }
                        }
                        break;
                    case "maxFail":
                        item = {
                            "maxFail": {
                                "MAX": "courses_fail"
                            }
                        }
                        break;
                    case "maxSectionNumber":
                        item = {
                            "maxSectionNumber": {
                                "COUNT": "courses_uuid"
                            }
                        }

                }
                apply.push(item)
            }
            transformations["APPLY"] = apply
            return transformations
        }

        function formRoomQuery(serializedSplit){
            var whereValue
            var whereKey
            var where = {}
            var aQuery = {}

            // WHERE
            var logic = serializedSplit[serializedSplit.length-1].split("=")[1]
            var and = []
            for(i=0; i<8; i++){
                whereKey = serializedSplit[i].split("=")[0]
                whereValue = serializedSplit[i].split("=")[1]
                var obj = {}
                if(whereValue != "" && whereValue != undefined){
                    switch (whereKey){
                        case "BuildingName":
                            obj = {
                                "IS": {
                                    'rooms_fullname': decodeURI(whereValue)
                                }
                            }
                            and.push(obj)
                            break;
                        case "RoomNumber":
                            obj = {
                                "IS": {
                                    'rooms_number': whereValue
                                }
                            }
                            and.push(obj)
                            break;
                        case "RoomSize":
                            obj[serializedSplit[i-1].split("=")[1]] = {
                                    'rooms_seats': Number(whereValue)
                            }
                            and.push(obj)
                            break;
                        case "RoomType":
                            obj = {
                                "IS": {
                                    'rooms_type': decodeURI(whereValue)
                                }
                            }
                            and.push(obj)
                            break;
                        case "FurnitureType":
                            obj = {
                                "IS": {
                                    'rooms_furniture': decodeURI(whereValue)
                                }
                            }
                            and.push(obj)
                            break;
                        case 6:

                            break;
                        case 7:

                            break;
                    }
                }
            }
            where[logic] = and
            aQuery["WHERE"] = where

            // OPTIONS
            var options = {}
            options["COLUMNS"] = [
                "rooms_name",
                "rooms_number",
                "rooms_seats",
                "rooms_furniture",
                "rooms_type",
                "rooms_href",
                "rooms_shortname",
                "rooms_fullname",
                "rooms_address",
                "rooms_lat",
                "rooms_lon"
            ]
            options["FORM"] = "TABLE"
            aQuery["OPTIONS"] = options
            //console.log(aQuery)
            return aQuery
        }

        function locationFilter(input,serializedSplit){
            var building
            var distance
            var array = []
            for(i=0; i<serializedSplit.length; i++) {
                if (serializedSplit[i].split("=")[0] == "Building"){
                    building = serializedSplit[i].split("=")[1]
                }
                if (serializedSplit[i].split("=")[0] == "Distance"){
                    distance = serializedSplit[i].split("=")[1]
                }
            }
            if(building != "") {
                var queryForGeo ={
                    "WHERE": {
                        "IS": {
                            "rooms_shortname": building
                        }
                    },
                "OPTIONS": {
                    "COLUMNS": [
                        "rooms_lat",
                        "rooms_lon"
                    ],
                        "FORM": "TABLE"
                },
                "TRANSFORMATIONS": {
                    "GROUP": ["rooms_lat","rooms_lon"],
                        "APPLY": []
                }
            }
                var lat2
                var lon2
                var R = 6371; // Radius of the earth in km
                return $.ajax({
                    url: 'http://localhost:4321/query',
                    type: 'post',
                    data: JSON.stringify(queryForGeo),
                    dataType: 'json',
                    contentType: 'application/json'
                }).done(function(data){
                    var lat1 = data.result[0]["rooms_lat"]
                    var lon1 = data.result[0]["rooms_lon"]
                    for (i = 0; i < input.length; i++) {
                        lat2 = input[i]["rooms_lat"]
                        lon2 = input[i]["rooms_lon"]
                        var dLat = deg2rad(lat2-lat1);  // deg2rad below
                        var dLon = deg2rad(lon2-lon1);
                        var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                        var d = R * c * 1000; // Distance in km
                        if(d <= distance){
                            array.push(input[i])
                        }
                    }
                    generateTable(array,"room")
                    console.log("Response",array)
                }).fail(function(error){
                    console.error("ERROR - Failed to submit")
                })
            }else{
                generateTable(input,"room")
                console.log("Response",input)
            }
        }

        function deg2rad(deg) {
            return deg * (Math.PI/180)
        }

        function generateTable(results,dataset){
            var tbl_body = document.createElement("tbody");
            var odd_even = true;
            //console.log("DATA", results);

            var head_row = tbl_body.insertRow();
            head_row.className = odd_even ? "odd" : "even";
            $.each(Object.keys(results[0]), function(k,v){
                var th = document.createElement('th');
                th.innerHTML = v.toString().split("_")[1];
                if(th.innerHTML == "undefined"){
                    th.innerHTML = v.toString()
                }
                head_row.appendChild(th)
            })
            odd_even = !odd_even

            //------------------
            $.each(results, function() {
                var tbl_row = tbl_body.insertRow();
                tbl_row.className = odd_even ? "odd" : "even";
                $.each(this, function(k,v){
                    var cell = tbl_row.insertCell();
                    cell.appendChild(document.createTextNode(v.toString()))
                })
                odd_even = !odd_even
            })
            if(dataset == "course"){
                document.getElementById("tblResultsCourse").appendChild(tbl_body)
            }
            if(dataset == "room"){
                document.getElementById("tblResultsRoom").appendChild(tbl_body)
            }
            //$("#tblResults").appendChild(tbl_body)
        }
    </script>
    <style>
        body{
            font-family: "Trebuchet MS", sans-serif;
            margin: 50px;
        }
        th {
            font-family: "Trebuchet MS", sans-serif;
            background-color: #007fff;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2
        }
        .demoHeaders {
            margin-top: 2em;
        }
        #dialog-link {
            padding: .4em 1em .4em 20px;
            text-decoration: none;
            position: relative;
        }
        #dialog-link span.ui-icon {
            margin: 0 5px 0 0;
            position: absolute;
            left: .2em;
            top: 50%;
            margin-top: -8px;
        }
        #icons {
            margin: 0;
            padding: 0;
        }
        #icons li {
            margin: 2px;
            position: relative;
            padding: 4px 0;
            cursor: pointer;
            float: left;
            list-style: none;
        }
        #icons span.ui-icon {
            float: left;
            margin: 0 4px;
        }
        .fakewindowcontain .ui-widget-overlay {
            position: absolute;
        }
        select {
            width: 200px;
        }
    </style>
</head>
<body>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->

<!-- Include all compiled plugins (below), or include individual files as needed -->
<!--<script src="js/bootstrap.min.js"></script>-->

<!-- Tabs -->
<h2 class="demoHeaders">UI</h2>
<div id="tabs">
    <ul>
        <li><a href="#tabs-1">Course Explorer</a></li>
        <li><a href="#tabs-2">Room Explorer</a></li>
        <li><a href="#tabs-3">Room Schedule</a></li>
    </ul>
    <div id="tabs-1">
        <form id="form1">
            Filters:<br>
            Section size: <label class = "radio"><input type="radio" name="SectionSizeCom" value="GT">Greater Than</label>
                            <label class = "radio"><input type="radio" name="SectionSizeCom" value="LT">Less Than</label>
                            <input type="text" name="SectionSize"><br>
            Department: <input type="text" name="Department"><br>
            Course number: <input type="text" name="CourseNumber"><br>
            Instructor: <input type="text" name="Instructor"><br>
            Title: <input type="text" name="Title"><br>
            Logic: <label class = "radio"><input type="radio" name="Logic" value="AND">AND</label>
                   <label class = "radio"><input type="radio" name="Logic" value="OR">OR</label><br><br>
            Course Exploration: <br>
            Order: <label class = "radio"><input type="radio" name="Direction" value="UP">Up</label>
                       <label class = "radio"><input type="radio" name="Direction" value="DOWN">Down</label><br>
            Sort by:<br>
                     <label class = "checkbox"><input type="checkbox" name="SortBy" value="maxAvg">Highest Average</label><br>
                     <label class = "checkbox"><input type="checkbox" name="SortBy" value="minAvg">Lowest Average</label><br>
                     <label class = "checkbox"><input type="checkbox" name="SortBy" value="maxPass">Most Passes</label><br>
                     <label class = "checkbox"><input type="checkbox" name="SortBy" value="maxFail">Most Fails</label><br>
                     <label class = "checkbox"><input type="checkbox" name="SortBy" value="maxSectionNumber">Most Sections</label><br>
        </form><br>
        <button id="course">submit</button><br>
        <table id="tblResultsCourse"></table>
    </div>
    <div id="tabs-2">
        <form id="form2">
            Building name: <input type="text" name="BuildingName"><br>
            Room number: <input type="text" name="RoomNumber"><br>
            Room size: <label class = "radio"><input type="radio" name="RoomSizeCom" value="GT">Greater Than</label>
                       <label class = "radio"><input type="radio" name="RoomSizeCom" value="LT">Less Than</label>
                       <input type="text" name="RoomSize"><br>
            Room type: <input type="text" name="RoomType"><br>
            Furniture type: <input type="text" name="FurnitureType"><br>
            Location: <input type="text" name="Distance">meters from<input type="text" name="Building"><br><br>
            Logic:<label class = "radio"><input type="radio" name="Logic" value="AND">AND</label>
                  <label class = "radio"><input type="radio" name="Logic" value="OR">OR</label><br><br>
        </form>
        <button id="room">submit</button><br>
        <table id="tblResultsRoom"></table>
    </div>
    <div id="tabs-3">
        <form id="form3">
            Course Input:<br>
            <textarea class="form-control" rows="10" cols = "70" id="roomInput"></textarea>
        </form>
        <form id="form4">
            Room Input:<br>
            <textarea class="form-control" rows="10" cols = "70" id="courseInput"></textarea>
        </form>
        <button id="scheduleInput">submit</button><br>
        <table id="tblResultsSchedule"></table>
    </div>
</div>
<!--<script src="external/jquery/jquery.js"></script>-->
<script src="jquery-ui.js"></script>
<script>
    $( "#tabs" ).tabs();
</script>

</body>
</html>